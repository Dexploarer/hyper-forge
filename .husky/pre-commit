#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Change to the repository root
cd "$(git rev-parse --show-toplevel)"

# 1. Run type checking
echo "\nğŸ“ Type checking..."
cd packages/core && bun run typecheck || {
  echo "âŒ Type checking failed! Please fix TypeScript errors before committing."
  exit 1
}

# Return to root
cd ../..

# 2. Run linter with auto-fix
echo "\nğŸ”§ Running linter..."
cd packages/core && bun run lint || {
  echo "âŒ Linting failed! Please fix linting errors before committing."
  exit 1
}

# Return to root
cd ../..

# 3. Format code with Prettier
echo "\nâœ¨ Formatting code..."
bunx prettier --write --ignore-unknown $(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx|json|css|md)$') || {
  echo "âŒ Code formatting failed!"
  exit 1
}

# Stage formatted files
git update-index --again

# 4. Run relevant tests (only unit tests for speed)
echo "\nğŸ§ª Running unit tests..."
cd packages/core && bun test __tests__/unit || {
  echo "âŒ Unit tests failed! Please fix failing tests before committing."
  exit 1
}

echo "\nâœ… All pre-commit checks passed!"
